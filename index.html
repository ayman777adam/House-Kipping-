<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Luxury Cloud</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#d97706">
    <link rel="apple-touch-icon" href="./icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Tajawal', 'sans-serif'] },
                    boxShadow: {
                        'luxury': '0 4px 20px -2px rgba(0, 0, 0, 0.1)',
                        'gold': '0 4px 15px -3px rgba(217, 119, 6, 0.3)'
                    }
                }
            }
        }
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .picker-anim { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .row-anim { animation: fadeInScale 0.3s ease-out forwards; }

        /* Error Animation - Restored & Improved */
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .error-pulse { animation: pulseRed 1.5s infinite; border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        .dark .error-pulse { background-color: #450a0a !important; border-color: #ef4444 !important; }

        input[type="time"]::-webkit-calendar-picker-indicator { display: none; }
        input[type="time"] { background: transparent; border: none; color: inherit; text-align: center; font-family: 'Tajawal', sans-serif; font-weight: bold; width: 60px; padding: 0; }
        input[type="time"]:focus { outline: none; background: rgba(255,255,255,0.1); border-radius: 4px; }

        @media print {
            @page { size: A4 landscape; margin: 5mm; }
            html, body { height: auto !important; overflow: visible !important; background-color: white !important; color: black !important; display: block !important; }
            #mainApp { display: none !important; } 
            #loginScreen, #pickerModal, #closeOptionsModal, #teamModal, #langModal, #historyModal, #statsModal, .no-print { display: none !important; }
            #printArea { display: block !important; width: 100%; position: absolute; top: 0; left: 0; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; border: 2px solid #000; direction: ltr !important; }
            th, td { border: 1px solid #000; padding: 6px; text-align: center; }
            th { background-color: #eee !important; font-weight: bold; -webkit-print-color-adjust: exact; }
            .section-header { background-color: #ddd !important; font-weight: bold; font-size: 14px; text-align: left; padding: 8px; -webkit-print-color-adjust: exact; }
            .print-logo { font-size: 20px; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 5px; }
            .print-meta { margin-bottom: 15px; font-size: 12px; display: flex; justify-content: space-between; direction: ltr !important; }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 text-gray-800 dark:text-gray-100 h-[100dvh] flex flex-col overflow-hidden transition-colors duration-300">

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginScreen" class="fixed inset-0 z-[200] bg-slate-900 flex flex-col items-center justify-center p-6 text-white overflow-y-auto">
        <button onclick="app.openLangModal()" class="absolute top-6 right-6 w-10 h-10 rounded-full bg-gray-800 border border-gray-600 flex items-center justify-center text-amber-500 shadow-lg active:scale-95 transition-all">
            <i class="fas fa-globe text-xl"></i>
        </button>

        <div class="w-full max-w-md space-y-6 text-center">
            <div class="inline-block p-5 rounded-full border-2 border-amber-500/50 bg-gradient-to-b from-gray-800 to-gray-900 shadow-2xl shadow-amber-500/20">
                <i class="fas fa-crown text-4xl text-amber-500"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold mb-1 text-amber-500">ELITE CLOUD</h1>
                <p class="text-gray-400 text-xs tracking-widest uppercase" data-i18n="systemTitle">Multi-User System</p>
            </div>

            <div class="bg-gray-800/80 backdrop-blur-md p-5 rounded-2xl border border-gray-700 space-y-4 shadow-xl">
                <div class="space-y-1">
                    <p class="text-xs text-gray-400 text-right pr-1 font-bold" data-i18n="branchCodeLabel">ÙƒÙˆØ¯ Ø§Ù„ÙØ±Ø¹ (1 Ø£Ùˆ 2):</p>
                    <input type="tel" id="branchCode" class="w-full p-3 rounded-xl bg-gray-900 border border-gray-600 focus:border-amber-500 outline-none text-center font-bold text-2xl tracking-widest transition-all text-amber-500 placeholder-gray-700" placeholder="****" maxlength="4">
                </div>
                
                <input type="text" id="loginName" class="w-full p-3 rounded-xl bg-gray-900 border border-gray-600 focus:border-amber-500 outline-none text-center font-bold text-lg transition-all placeholder-gray-600" data-i18n-placeholder="supervisorPlaceholder" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù">
                
                <div class="space-y-1 relative">
                    <input type="password" id="loginPin" class="w-full p-3 rounded-xl bg-gray-900 border border-gray-600 focus:border-red-500 outline-none text-center font-bold text-lg transition-all placeholder-gray-600" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ (PIN)">
                </div>

                <div class="h-px bg-gray-700 my-2"></div>
                
                <div class="space-y-2">
                    <p class="text-xs text-gray-400 text-right pr-1" data-i18n="teamLabel">ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„ (Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø·):</p>
                    <div class="flex gap-2">
                        <input type="text" id="workerInput" onkeydown="if(event.key === 'Enter') app.addWorker(true)" class="flex-1 p-3 rounded-xl bg-gray-900 border border-gray-600 outline-none text-sm text-center placeholder-gray-600" data-i18n-placeholder="addName" placeholder="Ø§Ø¶Ø§ÙØ© Ø§Ø³Ù…">
                        <button onclick="app.addWorker(true)" class="bg-gray-700 hover:bg-amber-500 text-white w-12 rounded-xl font-bold transition-colors"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="workersTags" class="flex flex-wrap gap-2 justify-center min-h-[30px]"></div>
                </div>
            </div>

            <button onclick="app.login()" class="w-full bg-gradient-to-r from-amber-600 to-amber-500 text-white font-bold p-4 rounded-2xl text-lg shadow-gold hover:shadow-lg transform active:scale-95 transition-all border border-amber-400/30">
                <span data-i18n="loginBtn">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</span>
            </button>
        </div>
    </div>

    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="mainApp" class="hidden flex-col h-full relative">
        <header class="bg-white dark:bg-slate-800 p-4 shadow-lg z-30 flex-none rounded-b-3xl border-b dark:border-slate-700">
            <div class="dev-signature-header text-[9px] text-gray-400 dark:text-gray-500 text-center font-mono mb-2 tracking-widest uppercase">
                Connected: <span id="connStatus" class="text-green-500">Online</span>
            </div>

            <div class="flex justify-between items-center mb-1">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl flex items-center justify-center text-white shadow-gold">
                        <i class="fas fa-building"></i>
                    </div>
                    <div>
                        <h2 id="headerBranchName" class="font-bold text-lg leading-tight dark:text-amber-500">...</h2>
                        <div class="text-xs text-gray-400 font-medium">
                            <span data-i18n="supTitle">Supervisor</span>: <span id="headerName" class="text-gray-600 dark:text-gray-300 font-bold">...</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.openHistoryModal()" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-slate-700 text-purple-500 flex items-center justify-center hover:bg-purple-50">
                        <i class="fas fa-history"></i>
                    </button>
                    <button onclick="app.openStatsModal()" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-slate-700 text-green-500 flex items-center justify-center hover:bg-green-50">
                        <i class="fas fa-chart-pie"></i>
                    </button>
                    <button onclick="app.openTeamModal()" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-slate-700 text-blue-500 flex items-center justify-center hover:bg-blue-50">
                        <i class="fas fa-users-cog"></i>
                    </button>
                     <button onclick="app.logout()" class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/30 text-red-500 flex items-center justify-center hover:bg-red-50">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 space-y-4 pb-32">
            <div id="rowsContainer" class="space-y-4"></div>
            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 opacity-40">
                <i class="fas fa-cloud text-6xl mb-4 text-gray-400"></i>
                <p class="font-bold text-gray-500" data-i18n="readyMsg">Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„</p>
            </div>
        </main>

        <div class="fixed bottom-24 left-0 right-0 flex justify-center gap-4 px-6 z-[100] pointer-events-none no-print">
            <button onclick="app.addRow('checkout')" class="pointer-events-auto flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white py-3 rounded-2xl shadow-lg font-bold flex items-center justify-center gap-2 transform active:scale-95 transition-all border border-red-400">
                <i class="fas fa-sign-out-alt"></i> <span data-i18n="checkout">Ù…ØºØ§Ø¯Ø±Ø©</span>
            </button>
            <button onclick="app.addRow('customer')" class="pointer-events-auto flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 rounded-2xl shadow-lg font-bold flex items-center justify-center gap-2 transform active:scale-95 transition-all border border-blue-400">
                <i class="fas fa-user-check"></i> <span data-i18n="guest">Ù†Ø²ÙŠÙ„</span>
            </button>
        </div>

        <footer class="bg-white dark:bg-slate-800 p-4 border-t dark:border-slate-700 z-50 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
            <button onclick="app.validateAndOpenCloseModal()" class="w-full bg-gray-900 dark:bg-black text-white p-4 rounded-2xl font-bold shadow-lg flex items-center justify-center gap-3 active:scale-95 transition-all">
                <span data-i18n="closeShift">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´ÙØª (Ù…Ø³Ø­)</span>
                <i class="fas fa-arrow-left"></i>
            </button>
        </footer>
    </div>

    <!-- Modals -->
    <div id="historyModal" class="fixed inset-0 z-[260] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="document.getElementById('historyModal').classList.add('hidden')"></div>
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-3xl p-6 relative z-10 animate-pop-in flex flex-col max-h-[80vh]">
            <h3 class="text-xl font-bold text-center mb-4 dark:text-purple-400">Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø±Ø´ÙŠÙ)</h3>
            <div class="flex gap-2 mb-4">
                <input type="date" id="historyDate" class="flex-1 p-3 bg-gray-100 dark:bg-slate-700 dark:text-white rounded-xl font-bold text-center">
                <button onclick="app.fetchHistory()" class="bg-purple-500 text-white px-4 rounded-xl font-bold"><i class="fas fa-search"></i></button>
            </div>
            <div id="historyList" class="flex-1 overflow-y-auto space-y-2 min-h-[200px] border-t border-gray-200 dark:border-slate-700 pt-2">
                <p class="text-center text-gray-400 mt-10">Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„</p>
            </div>
            <button onclick="document.getElementById('historyModal').classList.add('hidden')" class="w-full mt-4 py-3 bg-gray-700 text-white rounded-xl font-bold">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="statsModal" class="fixed inset-0 z-[260] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="document.getElementById('statsModal').classList.add('hidden')"></div>
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-3xl p-6 relative z-10 animate-pop-in">
            <h3 class="text-xl font-bold text-center mb-6 dark:text-green-400">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±ÙŠÙ‚ (Ø§Ù„Ø¢Ù†)</h3>
            <div id="statsList" class="space-y-3"></div>
            <button onclick="document.getElementById('statsModal').classList.add('hidden')" class="w-full mt-6 py-3 bg-gray-700 text-white rounded-xl font-bold">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="langModal" class="fixed inset-0 z-[250] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="document.getElementById('langModal').classList.add('hidden')"></div>
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-3xl p-6 relative z-10 animate-pop-in">
            <h3 class="text-xl font-bold text-center mb-6 dark:text-white" data-i18n="selectLang">Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©</h3>
            <div class="grid grid-cols-1 gap-3">
                <button onclick="app.setLanguage('ar')" class="p-4 rounded-xl bg-gray-100 dark:bg-slate-700 font-bold text-lg flex items-center justify-between dark:text-white"><span>ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span></button>
                <button onclick="app.setLanguage('en')" class="p-4 rounded-xl bg-gray-100 dark:bg-slate-700 font-bold text-lg flex items-center justify-between dark:text-white"><span>ğŸ‡ºğŸ‡¸ English</span></button>
                <button onclick="app.setLanguage('hi')" class="p-4 rounded-xl bg-gray-100 dark:bg-slate-700 font-bold text-lg flex items-center justify-between dark:text-white"><span>ğŸ‡®ğŸ‡³ Hindi</span></button>
                <button onclick="app.setLanguage('bn')" class="p-4 rounded-xl bg-gray-100 dark:bg-slate-700 font-bold text-lg flex items-center justify-between dark:text-white"><span>ğŸ‡§ğŸ‡© Bengali</span></button>
            </div>
            <button onclick="document.getElementById('langModal').classList.add('hidden')" class="w-full mt-4 py-3 bg-red-500 text-white rounded-xl font-bold">Close</button>
        </div>
    </div>

    <div id="teamModal" class="fixed inset-0 z-[160] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="document.getElementById('teamModal').classList.add('hidden')"></div>
        <div class="bg-gray-800 w-full max-w-sm rounded-3xl p-6 relative z-10 animate-pop-in border border-amber-500/30 text-white">
            <h3 class="text-xl font-bold text-center mb-4 text-amber-500" data-i18n="teamTitle">Ø§Ù„ÙØ±ÙŠÙ‚</h3>
            <div class="flex gap-2 mb-4">
                <input type="text" id="modalWorkerInput" onkeydown="if(event.key === 'Enter') app.addWorker(false)" class="flex-1 p-3 rounded-xl bg-gray-900 border border-gray-600 outline-none text-sm text-center" data-i18n-placeholder="addName" placeholder="Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù…">
                <button onclick="app.addWorker(false)" class="bg-amber-500 text-black w-12 rounded-xl font-bold hover:bg-amber-400"><i class="fas fa-plus"></i></button>
            </div>
            <div id="modalTeamList" class="flex flex-wrap gap-2 justify-center mb-4 min-h-[50px] max-h-[200px] overflow-y-auto"></div>
            <button onclick="document.getElementById('teamModal').classList.add('hidden')" class="w-full py-3 bg-gray-700 rounded-xl font-bold" data-i18n="closeBtn">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="pickerModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="app.closePicker()"></div>
        <div class="absolute bottom-0 w-full bg-white dark:bg-slate-800 rounded-t-3xl p-6 picker-anim max-h-[70vh] flex flex-col">
            <h3 id="pickerTitle" class="text-xl font-bold text-center mb-6 dark:text-amber-500">...</h3>
            <div id="pickerGrid" class="grid grid-cols-3 gap-3 overflow-y-auto p-1 hide-scroll"></div>
        </div>
    </div>

    <div id="closeOptionsModal" class="fixed inset-0 z-[150] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="document.getElementById('closeOptionsModal').classList.add('hidden')"></div>
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-3xl p-6 relative z-10 animate-pop-in">
            <h3 class="text-xl font-bold text-center mb-6 dark:text-white" data-i18n="reportOptions">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h3>
            <div class="space-y-3">
                <button onclick="app.printPDF()" class="w-full py-4 bg-gray-100 dark:bg-slate-700 dark:text-white rounded-2xl font-bold flex items-center justify-center gap-3"><i class="fas fa-print"></i> PDF</button>
                <button onclick="app.sendWhatsApp()" class="w-full py-4 bg-[#25D366] text-white rounded-2xl font-bold flex items-center justify-center gap-3 shadow-lg"><i class="fab fa-whatsapp text-2xl"></i> WhatsApp</button>
                <div class="h-px bg-gray-200 dark:bg-slate-700 my-2"></div>
                <button onclick="app.finishShift()" class="w-full py-4 bg-red-500 text-white rounded-2xl font-bold flex items-center justify-center gap-3 shadow-lg"><i class="fas fa-trash-alt"></i> <span data-i18n="deleteAll">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„ÙƒÙ„)</span></button>
            </div>
        </div>
    </div>

    <!-- Ø·Ø¨Ø§Ø¹Ø© Ù…Ø®ÙÙŠØ© -->
    <div id="printArea" class="hidden">
        <div class="print-meta">
            <div class="print-logo">ELITE Housekeeping</div>
            <div style="text-align: left;">
                <div>Date: <span id="pDate"></span></div>
                <div>Branch: <span id="pBranch"></span></div>
                <div>Supervisor: <span id="pName"></span></div>
            </div>
        </div>
        <table>
            <thead>
                <tr><th rowspan="2" width="10%">Room</th><th colspan="5">Cleaning Staff</th><th colspan="2">Timing</th></tr>
                <tr><th width="12%">Living</th><th width="12%">Kitchen</th><th width="12%">Bath</th><th width="12%">Bed 1</th><th width="12%">Bed 2</th><th width="10%">Start</th><th width="10%">End</th></tr>
            </thead>
            <tbody id="printBody"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, updateDoc, doc, deleteDoc, setDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCcyDoYCN4jBrJOxoGRpVTxUczy4qF5yrI",
            authDomain: "house-kipping.firebaseapp.com",
            projectId: "house-kipping",
            storageBucket: "house-kipping.firebasestorage.app",
            messagingSenderId: "788154594334",
            appId: "1:788154594334:web:2d297efe5b06bb4ea1ea0f"
        };

        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);
        
        window.dbRef = db;
        window.fb = { collection, addDoc, query, where, onSnapshot, updateDoc, doc, deleteDoc, setDoc, getDocs, writeBatch, serverTimestamp: () => new Date().toISOString() };
        
        if(window.app && window.app.onFirebaseReady) window.app.onFirebaseReady();
    </script>

    <script>
        const translations = {
            ar: { systemTitle: "Ù†Ø¸Ø§Ù… Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", branchCodeLabel: "ÙƒÙˆØ¯ Ø§Ù„ÙØ±Ø¹ (1 Ø£Ùˆ 2):", supervisorPlaceholder: "Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù", teamLabel: "ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„ (Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø·):", addName: "Ø§Ø¶Ø§ÙØ© Ø§Ø³Ù…", loginBtn: "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…", supTitle: "Ø§Ù„Ù…Ø´Ø±Ù", readyMsg: "Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„", checkout: "Ù…ØºØ§Ø¯Ø±Ø©", guest: "Ù†Ø²ÙŠÙ„", closeShift: "Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´ÙØª (Ù…Ø³Ø­)", selectLang: "Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©", teamTitle: "Ø§Ù„ÙØ±ÙŠÙ‚", closeBtn: "Ø¥ØºÙ„Ø§Ù‚", reportOptions: "Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±", deleteAll: "Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„ÙƒÙ„)", floor: "Ø§Ù„Ø¯ÙˆØ±", room: "ØºØ±ÙØ©", workerLabel: "Ø¹Ø§Ù…Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©", corniche: "ÙØ±Ø¹ Ø§Ù„ÙƒÙˆØ±Ù†ÙŠØ´", andalus: "ÙØ±Ø¹ Ø§Ù„Ø£Ù†Ø¯Ù„Ø³" },
            en: { systemTitle: "Multi-User System", branchCodeLabel: "Branch Code (1 or 2):", supervisorPlaceholder: "Supervisor Name", teamLabel: "Staff Team (Local):", addName: "Add Name", loginBtn: "Login", supTitle: "Supervisor", readyMsg: "System Ready", checkout: "Checkout", guest: "Guest", closeShift: "Close Shift (Clear)", selectLang: "Select Language", teamTitle: "Team", closeBtn: "Close", reportOptions: "Report Options", deleteAll: "Clear All Data", floor: "Floor", room: "Room", workerLabel: "Area Staff", corniche: "Corniche Branch", andalus: "Andalus Branch" },
            hi: { systemTitle: "à¤®à¤²à¥à¤Ÿà¥€-à¤¯à¥‚à¤œà¤° à¤¸à¤¿à¤¸à¥à¤Ÿà¤®", branchCodeLabel: "à¤¬à¥à¤°à¤¾à¤‚à¤š à¤•à¥‹à¤¡ (1 à¤¯à¤¾ 2):", supervisorPlaceholder: "à¤¸à¥à¤ªà¤°à¤µà¤¾à¤‡à¤œà¤° à¤•à¤¾ à¤¨à¤¾à¤®", teamLabel: "à¤Ÿà¥€à¤® (à¤¸à¤¿à¤°à¥à¤« à¤†à¤ªà¤•à¥‡ à¤«à¥‹à¤¨ à¤®à¥‡à¤‚):", addName: "à¤¨à¤¾à¤® à¤œà¥‹à¤¡à¤¼à¥‡à¤‚", loginBtn: "à¤²à¥‰à¤—à¤¿à¤¨ à¤•à¤°à¥‡à¤‚", supTitle: "à¤¸à¥à¤ªà¤°à¤µà¤¾à¤‡à¤œà¤°", readyMsg: "à¤¸à¤¿à¤¸à¥à¤Ÿà¤® à¤¤à¥ˆà¤¯à¤¾à¤° à¤¹à¥ˆ", checkout: "à¤šà¥‡à¤•-à¤†à¤‰à¤Ÿ", guest: "à¤—à¥‡à¤¸à¥à¤Ÿ (Guest)", closeShift: "à¤¶à¤¿à¤«à¥à¤Ÿ à¤¬à¤‚à¤¦ à¤•à¤°à¥‡à¤‚ (Clear)", selectLang: "à¤­à¤¾à¤·à¤¾ à¤šà¥à¤¨à¥‡à¤‚", teamTitle: "à¤Ÿà¥€à¤®", closeBtn: "à¤¬à¤‚à¤¦ à¤•à¤°à¥‡à¤‚", reportOptions: "à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ à¤µà¤¿à¤•à¤²à¥à¤ª", deleteAll: "à¤¸à¤¬ à¤¡à¤¿à¤²à¥€à¤Ÿ à¤•à¤°à¥‡à¤‚", floor: "à¤«à¥à¤²à¥‹à¤°", room: "à¤°à¥‚à¤®", workerLabel: "à¤¸à¥à¤Ÿà¤¾à¤«", corniche: "à¤•à¥‹à¤°à¥à¤¨à¤¿à¤¶ à¤¬à¥à¤°à¤¾à¤‚à¤š", andalus: "à¤…à¤‚à¤¦à¤¾à¤²à¥à¤¸ à¤¬à¥à¤°à¤¾à¤‚à¤š" },
            bn: { systemTitle: "à¦®à¦¾à¦²à§à¦Ÿà¦¿-à¦‡à¦‰à¦œà¦¾à¦° à¦¸à¦¿à¦¸à§à¦Ÿà§‡à¦®", branchCodeLabel: "à¦¬à§à¦°à¦¾à¦à§à¦š à¦•à§‹à¦¡ (1 à¦¬à¦¾ 2):", supervisorPlaceholder: "à¦¸à§à¦ªà¦¾à¦°à¦­à¦¾à¦‡à¦œà¦¾à¦° à¦¨à¦¾à¦®", teamLabel: "à¦Ÿà¦¿à¦® (à¦†à¦ªà¦¨à¦¾à¦° à¦®à§‹à¦¬à¦¾à¦‡à¦²à§‡):", addName: "à¦¨à¦¾à¦® à¦²à¦¿à¦–à§à¦¨", loginBtn: "à¦²à¦—à¦‡à¦¨ à¦•à¦°à§à¦¨", supTitle: "à¦¸à§à¦ªà¦¾à¦°à¦­à¦¾à¦‡à¦œà¦¾à¦°", readyMsg: "à¦¸à¦¿à¦¸à§à¦Ÿà§‡à¦® à¦°à§‡à¦¡à¦¿", checkout: "à¦šà§‡à¦•-à¦†à¦‰à¦Ÿ", guest: "à¦—à§‡à¦¸à§à¦Ÿ (Guest)", closeShift: "à¦¶à¦¿à¦«à¦Ÿ à¦¶à§‡à¦· à¦•à¦°à§à¦¨", selectLang: "à¦­à¦¾à¦·à¦¾ à¦¨à¦¿à¦°à§à¦¬à¦¾à¦šà¦¨ à¦•à¦°à§à¦¨", teamTitle: "à¦Ÿà¦¿à¦®", closeBtn: "à¦¬à¦¨à§à¦§ à¦•à¦°à§à¦¨", reportOptions: "à¦°à¦¿à¦ªà§‹à¦°à§à¦Ÿ à¦…à¦ªà¦¶à¦¨", deleteAll: "à¦¸à¦¬ à¦¡à¦¿à¦²à¦¿à¦Ÿ à¦•à¦°à§à¦¨", floor: "à¦«à§à¦²à§‹à¦°", room: "à¦°à§à¦®", workerLabel: "à¦¸à§à¦Ÿà¦¾à¦«", corniche: "à¦•à¦°à§à¦¨à¦¿à¦¶ à¦¬à§à¦°à¦¾à¦à§à¦š", andalus: "à¦†à¦¨à§à¦¦à¦¾à¦²à§à¦¸ à¦¬à§à¦°à¦¾à¦à§à¦š" }
        };

        const roomsConfig = {
            corniche: { 1: [101,102,103,104], 2: [201,202,203,204,205,206], 3: [301,302,303,304,305,306,307,308,309,310], 4: [401,402,403,404,405,406,407,408,409,410], 5: [501,502,503,504,505,506], 6: [601,602,603,604] },
            andalus: { 1: [101,102,103,104,105,106,107,108], 2: [201,202,203,204,205,206,207,208], 3: [301,302,303,304,305,306,307,308], 4: [401,402,403,404,405,406,407,408], 5: [501,502,503,504,505,506,507,508], 6: [601,602,603,604] }
        };

        const app = {
            state: { branchCode: null, branchKey: null, supervisor: '', data: [], unsubscribe: null, lang: 'ar' },
            localConfig: { theme: 'dark', teams: [], lang: 'ar' }, 
            activePicker: null,

            init() {
                const saved = localStorage.getItem('hk_elite_local');
                if(saved) {
                    this.localConfig = JSON.parse(saved);
                    if(!this.localConfig.teams) this.localConfig.teams = [];
                    this.state.lang = this.localConfig.lang || 'ar';
                }
                if(this.localConfig.theme === 'dark') document.documentElement.classList.add('dark');
                this.applyLanguage();
                
                const session = localStorage.getItem('hk_elite_session');
                if(session) {
                    const parsed = JSON.parse(session);
                    this.state.branchCode = parsed.code;
                    this.state.branchKey = parsed.key;
                    this.state.supervisor = parsed.name;
                    this.startAppMode();
                } else {
                    this.renderWorkerTags(true);
                }
            },

            login() {
                const code = document.getElementById('branchCode').value.trim();
                const name = document.getElementById('loginName').value.trim();
                const pin = document.getElementById('loginPin').value.trim();
                const CORRECT_PIN = "1234";

                if(!name) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù');
                if(pin !== CORRECT_PIN) return alert('â›” Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ!');

                let bKey = '';
                if(code === '1') bKey = 'corniche';
                else if(code === '2') bKey = 'andalus';
                else return alert('Ø®Ø·Ø£ ÙÙŠ ÙƒÙˆØ¯ Ø§Ù„ÙØ±Ø¹');

                this.state.branchCode = code;
                this.state.branchKey = bKey;
                this.state.supervisor = name;
                
                localStorage.setItem('hk_elite_session', JSON.stringify({ code, key: bKey, name }));
                this.startAppMode();
            },

            openLangModal() { document.getElementById('langModal').classList.remove('hidden'); },
            setLanguage(code) { this.state.lang = code; this.localConfig.lang = code; this.saveLocal(); this.applyLanguage(); document.getElementById('langModal').classList.add('hidden'); },
            applyLanguage() { 
                const t = translations[this.state.lang];
                document.documentElement.setAttribute('dir', this.state.lang === 'ar' ? 'rtl' : 'ltr');
                document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = t[el.getAttribute('data-i18n')] || '');
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = t[el.getAttribute('data-i18n-placeholder')] || '');
                if(this.state.branchKey) document.getElementById('headerBranchName').innerText = t[this.state.branchKey];
                if(this.state.data.length) this.renderList();
            },
            t(key) { return translations[this.state.lang][key] || key; },
            logout() { if(confirm('ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ØŸ')) { if(this.state.unsubscribe) this.state.unsubscribe(); localStorage.removeItem('hk_elite_session'); location.reload(); } },
            
            startAppMode() {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('flex');
                document.getElementById('headerBranchName').innerText = this.t(this.state.branchKey);
                document.getElementById('headerName').innerText = this.state.supervisor;
                this.listenRealtime();
            },

            listenRealtime() {
                if(!window.fb) { this.onFirebaseReady = () => this.listenRealtime(); return; }
                const q = window.fb.query(window.fb.collection(window.dbRef, "rooms"), window.fb.where("branch", "==", this.state.branchKey));
                this.state.unsubscribe = window.fb.onSnapshot(q, (snapshot) => {
                    this.state.data = [];
                    snapshot.forEach((doc) => this.state.data.push({ id: doc.id, ...doc.data() }));
                    this.state.data.sort((a, b) => {
                        if (a.section === 'checkout' && b.section !== 'checkout') return -1;
                        if (a.section !== 'checkout' && b.section === 'checkout') return 1;
                        return (a.timestamp || 0) - (b.timestamp || 0);
                    });
                    this.renderList();
                });
            },

            renderList() {
                const container = document.getElementById('rowsContainer');
                container.innerHTML = '';
                if(this.state.data.length === 0) { document.getElementById('emptyState').classList.remove('hidden'); return; }
                document.getElementById('emptyState').classList.add('hidden');
                this.state.data.forEach(item => container.appendChild(this.createLuxuryCard(item)));
            },

            createLuxuryCard(item) {
                const isCheckout = item.section === 'checkout';
                const bgClass = isCheckout ? 'bg-red-50 dark:bg-red-900/10' : 'bg-blue-50 dark:bg-blue-900/10';
                const borderClass = isCheckout ? 'border border-red-200 dark:border-red-900/50' : 'border border-blue-200 dark:border-blue-900/50';
                const sideStrip = isCheckout ? 'bg-red-500' : 'bg-blue-500';
                const roomActive = item.room ? (isCheckout ? 'text-red-700 dark:text-red-400' : 'text-blue-700 dark:text-blue-400') : 'text-gray-400';
                const hasNote = item.maintenance && item.maintenance.trim().length > 0;
                const maintColor = hasNote ? 'text-orange-500 animate-pulse' : 'text-gray-300';
                
                const div = document.createElement('div');
                // Increased top padding (pt-10) to prevent overlap
                div.className = `row-anim ${bgClass} ${borderClass} pt-10 p-4 rounded-2xl relative overflow-hidden group shadow-sm`;
                div.innerHTML += `<div class="absolute top-0 right-0 w-1.5 h-full ${sideStrip}"></div>`;
                div.innerHTML += `<button onclick="app.deleteRow('${item.id}')" class="absolute top-2 left-2 text-gray-300 hover:text-red-500 z-10 p-1"><i class="fas fa-times"></i></button>`;
                
                // Moved maintenance icon to the right (left-12) to avoid overlap
                div.innerHTML += `<button onclick="app.toggleMaintenance('${item.id}', '${item.maintenance || ''}')" class="absolute top-2 left-12 ${maintColor} hover:text-orange-600 z-10 p-1"><i class="fas fa-tools"></i></button>`;

                const floorVal = item.floor ? `${this.t('floor')} ${item.floor}` : this.t('floor');
                const roomVal = item.room || this.t('room');
                const mkBtn = (f, l) => `
                    <button onclick="app.openPicker('${item.id}', '${f}')" class="flex flex-col items-center justify-center p-2 rounded-xl transition-all ${item[f] ? (isCheckout ? 'bg-red-500 text-white' : 'bg-blue-500 text-white') : 'bg-white dark:bg-slate-800 text-gray-400 border border-gray-200 dark:border-slate-700'}">
                        <span class="text-[10px] font-bold uppercase opacity-80 mb-1">${l}</span>
                        <span class="font-bold text-xs truncate w-full text-center">${item[f] || '-'}</span>
                    </button>`;

                let maintAlert = hasNote ? `<div class="w-full bg-orange-100 text-orange-800 text-xs p-2 rounded mb-2 font-bold border border-orange-200">ğŸ› ï¸ ${item.maintenance}</div>` : '';

                div.innerHTML += `
                    ${maintAlert}
                    <div class="flex justify-between items-start mb-4 ${this.state.lang==='ar'?'pl-6':'pr-6'}">
                        <div class="flex gap-2">
                            <button onclick="app.openPicker('${item.id}', 'floor')" class="bg-white dark:bg-slate-800 px-3 py-2 rounded-xl text-xs font-bold text-gray-500 border dark:border-slate-700 min-w-[50px] shadow-sm">${floorVal}</button>
                            <button onclick="app.openPicker('${item.id}', 'room')" class="text-2xl font-black ${roomActive} flex items-center gap-2">${roomVal} <i class="fas fa-chevron-down text-xs opacity-50"></i></button>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                             <div id="time-start-${item.id}" class="flex items-center bg-white dark:bg-slate-800 rounded-lg p-1 border border-transparent dark:border-slate-700 shadow-sm transition-colors duration-300">
                                <span class="text-[10px] font-bold text-green-600 px-1">IN</span>
                                <input type="time" value="${item.start || ''}" onchange="app.updateField('${item.id}', 'start', this.value)" class="bg-transparent font-mono font-bold w-16 text-center text-xs dark:text-white focus:outline-none">
                                <button onclick="app.setNow('${item.id}', 'start')" class="w-6 h-6 bg-green-500 text-white rounded flex items-center justify-center shadow-lg active:scale-90"><i class="fas fa-play text-[10px]"></i></button>
                            </div>
                            <div id="time-end-${item.id}" class="flex items-center bg-white dark:bg-slate-800 rounded-lg p-1 border border-transparent dark:border-slate-700 shadow-sm transition-colors duration-300">
                                <span class="text-[10px] font-bold text-red-600 px-1">OUT</span>
                                <input type="time" value="${item.end || ''}" onchange="app.updateField('${item.id}', 'end', this.value)" class="bg-transparent font-mono font-bold w-16 text-center text-xs dark:text-white focus:outline-none">
                                <button onclick="app.setNow('${item.id}', 'end')" class="w-6 h-6 bg-red-500 text-white rounded flex items-center justify-center shadow-lg active:scale-90"><i class="fas fa-stop text-[10px]"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-5 gap-2">${mkBtn('living','Liv')}${mkBtn('kitchen','Kit')}${mkBtn('bath','Bath')}${mkBtn('bed1','B1')}${mkBtn('bed2','B2')}</div>
                    <div class="mt-2 text-[9px] text-gray-400 text-left w-full pl-1 font-mono">${item.lastEditor || ''}</div>
                `;
                return div;
            },

            toggleMaintenance(id, currentNote) {
                const note = prompt("Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© (Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„Ù„Ù…Ø³Ø­):", currentNote);
                if(note !== null) {
                    this.updateField(id, 'maintenance', note);
                }
            },

            openStatsModal() {
                const stats = {};
                this.state.data.forEach(item => {
                    ['living', 'kitchen', 'bath', 'bed1', 'bed2'].forEach(field => {
                        const name = item[field];
                        if(name) stats[name] = (stats[name] || 0) + 1;
                    });
                });
                
                const list = document.getElementById('statsList');
                list.innerHTML = '';
                if(Object.keys(stats).length === 0) list.innerHTML = '<p class="text-center text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
                else {
                    Object.entries(stats).sort((a,b) => b[1]-a[1]).forEach(([name, count]) => {
                        list.innerHTML += `<div class="flex justify-between bg-gray-100 dark:bg-slate-700 p-3 rounded-xl"><span class="font-bold dark:text-white">${name}</span><span class="bg-green-500 text-white px-2 rounded-lg font-mono">${count}</span></div>`;
                    });
                }
                document.getElementById('statsModal').classList.remove('hidden');
            },

            async finishShift() {
                if(!confirm(this.state.lang === 'ar' ? 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´ÙØª ÙˆÙ…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„.' : 'Archive and Clear Data?')) return;
                
                try {
                    const q = window.fb.query(window.fb.collection(window.dbRef, "rooms"), window.fb.where("branch", "==", this.state.branchKey));
                    const snapshot = await window.fb.getDocs(q);

                    if (snapshot.empty) {
                        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø³Ø­");
                        return;
                    }

                    const roomsData = [];
                    snapshot.forEach(doc => roomsData.push({ id: doc.id, ...doc.data() }));

                    const today = new Date().toISOString().split('T')[0];
                    const archiveData = { date: today, rooms: roomsData, timestamp: window.fb.serverTimestamp() };

                    const batch = window.fb.writeBatch(window.dbRef);
                    const historyRef = window.fb.doc(window.fb.collection(window.dbRef, `history_${this.state.branchKey}`));
                    batch.set(historyRef, archiveData);

                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    document.getElementById('closeOptionsModal').classList.add('hidden');
                    alert("âœ… ØªÙ… Ø§Ù„Ø£Ø±Ø´ÙØ© ÙˆØ§Ù„Ù…Ø³Ø­ Ø¨Ù†Ø¬Ø§Ø­");
                } catch(e) {
                    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + e.message);
                }
            },

            openHistoryModal() {
                document.getElementById('historyModal').classList.remove('hidden');
                document.getElementById('historyDate').value = new Date().toISOString().split('T')[0];
            },

            async fetchHistory() {
                const date = document.getElementById('historyDate').value;
                if(!date) return;
                
                const listDiv = document.getElementById('historyList');
                listDiv.innerHTML = '<p class="text-center mt-4"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>';

                const q = window.fb.query(
                    window.fb.collection(window.dbRef, `history_${this.state.branchKey}`),
                    window.fb.where("date", "==", date)
                );
                
                const snap = await window.fb.getDocs(q);
                listDiv.innerHTML = '';

                if(snap.empty) {
                    listDiv.innerHTML = '<p class="text-center text-red-400 mt-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</p>';
                    return;
                }

                snap.forEach(doc => {
                    const data = doc.data();
                    const block = document.createElement('div');
                    block.className = 'mb-4 bg-gray-50 dark:bg-slate-700 p-3 rounded-xl border border-gray-200 dark:border-slate-600';
                    block.innerHTML = `<h4 class="font-bold text-center text-purple-500 mb-2 border-b pb-1">Ø³Ø¬Ù„: ${new Date(data.timestamp).toLocaleTimeString('en-US')}</h4>`;
                    
                    if(data.rooms && data.rooms.length > 0) {
                        data.rooms.forEach(room => {
                            let workers = [];
                            if(room.living) workers.push(`Liv:${room.living}`);
                            if(room.kitchen) workers.push(`Kit:${room.kitchen}`);
                            if(room.bath) workers.push(`Bath:${room.bath}`);
                            if(room.bed1) workers.push(`B1:${room.bed1}`);
                            if(room.bed2) workers.push(`B2:${room.bed2}`);

                            block.innerHTML += `
                                <div class="py-2 border-b dark:border-slate-600 last:border-0 dark:text-gray-300">
                                    <div class="flex justify-between text-xs font-bold mb-1">
                                        <span class="w-12 text-base">${room.room}</span>
                                        <span>${room.section === 'checkout' ? 'ğŸ”´' : 'ğŸ”µ'}</span>
                                        <span class="font-mono text-xs">${room.start||'--'} > ${room.end||'--'}</span>
                                    </div>
                                    <div class="text-[10px] text-gray-500 dark:text-gray-400">
                                        ${workers.length > 0 ? workers.join(' | ') : 'No Workers'}
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        block.innerHTML += '<p class="text-xs text-center">ÙØ§Ø±Øº</p>';
                    }
                    listDiv.appendChild(block);
                });
            },

            async addRow(section) {
                try {
                    const newRow = { branch: this.state.branchKey, section: section, floor: '', room: '', living: '', kitchen: '', bath: '', bed1: '', bed2: '', start: '', end: '', maintenance: '', timestamp: new Date().toISOString(), lastEditor: this.state.supervisor };
                    await window.fb.addDoc(window.fb.collection(window.dbRef, "rooms"), newRow);
                    setTimeout(() => window.scrollTo({ top: 0, behavior: 'smooth' }), 100);
                } catch(e) { alert(e.message); }
            },
            async updateField(id, field, val) { const ref = window.fb.doc(window.dbRef, "rooms", id); const d = {}; d[field]=val; if(field==='floor') d['room']=''; d['lastEditor']=this.state.supervisor; await window.fb.updateDoc(ref, d); },
            async deleteRow(id) { if(confirm('Ø­Ø°ÙØŸ')) await window.fb.deleteDoc(window.fb.doc(window.dbRef, "rooms", id)); },
            setNow(id, field) { this.updateField(id, field, new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })); },
            
            addWorker(isLogin) {
                const id = isLogin ? 'workerInput' : 'modalWorkerInput';
                const v = document.getElementById(id).value.trim();
                if(v && !this.localConfig.teams.includes(v)) { this.localConfig.teams.push(v); this.saveLocal(); isLogin ? this.renderWorkerTags(true) : this.renderModalTeam(); }
                document.getElementById(id).value = '';
            },
            removeWorker(n, isLogin) { const i = this.localConfig.teams.indexOf(n); if(i>-1) { this.localConfig.teams.splice(i,1); this.saveLocal(); isLogin ? this.renderWorkerTags(true) : this.renderModalTeam(); } },
            renderWorkerTags() { document.getElementById('workersTags').innerHTML = this.localConfig.teams.map(w => `<span class="bg-gray-700 text-white px-3 py-1 rounded-full text-xs font-bold gap-2 flex">${w} <button onclick="app.removeWorker('${w}', true)" class="text-red-400">&times;</button></span>`).join(''); },
            renderModalTeam() { document.getElementById('modalTeamList').innerHTML = this.localConfig.teams.map(w => `<span class="bg-gray-700 text-white px-3 py-2 rounded-lg text-sm font-bold gap-2 flex">${w} <button onclick="app.removeWorker('${w}', false)" class="text-red-400"><i class="fas fa-trash"></i></button></span>`).join(''); },
            openTeamModal() { this.renderModalTeam(); document.getElementById('teamModal').classList.remove('hidden'); },
            toggleTheme() { document.documentElement.classList.toggle('dark'); this.localConfig.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; document.getElementById('themeIcon').className = this.localConfig.theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon'; this.saveLocal(); },
            saveLocal() { localStorage.setItem('hk_elite_local', JSON.stringify(this.localConfig)); },
            
            openPicker(id, field) {
                this.activePicker = { id, field };
                const item = this.state.data.find(i => i.id === id);
                if(!item) return;
                document.getElementById('pickerGrid').innerHTML = '';
                let opts = [];
                if(field === 'floor') opts = [1,2,3,4,5,6].map(f => ({v:f, l:f}));
                else if(field === 'room') opts = (roomsConfig[this.state.branchKey][item.floor]||[]).map(r => ({v:r, l:r}));
                else opts = this.localConfig.teams.map(w => ({v:w, l:w}));
                
                opts.forEach(o => {
                    const btn = document.createElement('button');
                    const active = item[field] == o.v;
                    const color = item.section === 'checkout' ? 'bg-red-500 ring-red-300' : 'bg-blue-500 ring-blue-300';
                    btn.className = `p-4 rounded-xl font-bold text-sm shadow-sm ${active ? `${color} text-white ring-2` : 'bg-gray-100 dark:bg-slate-700 dark:text-gray-200'}`;
                    btn.innerText = o.l;
                    btn.onclick = () => { this.updateField(id, field, o.v); this.closePicker(); };
                    document.getElementById('pickerGrid').appendChild(btn);
                });
                document.getElementById('pickerModal').classList.remove('hidden');
            },
            closePicker() { document.getElementById('pickerModal').classList.add('hidden'); },
            
            // --- VALIDATION RESTORED ---
            validateAndOpenCloseModal() { 
                if(this.state.data.length===0) return alert('Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©'); 
                
                // Reset Errors
                document.querySelectorAll('.error-pulse').forEach(el => el.classList.remove('error-pulse', 'border-red-500'));

                let hasError = false;
                
                // Check if any room number is missing
                if(this.state.data.some(i => !i.room)) return alert('âš ï¸ Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© Ù…ÙÙ‚ÙˆØ¯ ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª!');

                this.state.data.forEach(item => {
                    const startEl = document.getElementById(`time-start-${item.id}`);
                    const endEl = document.getElementById(`time-end-${item.id}`);

                    if(!item.start && startEl) {
                        startEl.classList.add('error-pulse', 'border-red-500');
                        hasError = true;
                    }
                    if(!item.end && endEl) {
                        endEl.classList.add('error-pulse', 'border-red-500');
                        hasError = true;
                    }
                });

                if(hasError) return alert('â›” ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¨Ø¯Ø¡ ÙˆØ§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡!');

                document.getElementById('closeOptionsModal').classList.remove('hidden'); 
            },
            
            printPDF() { 
                document.getElementById('pDate').innerText = new Date().toLocaleDateString('en-GB');
                document.getElementById('pBranch').innerText = this.state.branchKey === 'corniche' ? 'CORNICHE' : 'ANDALUS';
                document.getElementById('pName').innerText = this.state.supervisor;
                const tbody = document.getElementById('printBody');
                tbody.innerHTML = '';
                
                const sorted = [...this.state.data].sort((a,b) => (a.section === 'checkout' ? -1 : 1));
                let lastSection = '';
                sorted.forEach(item => {
                    if(item.section !== lastSection) {
                        const title = item.section === 'checkout' ? 'Check Out Rooms' : 'Customer Rooms';
                        tbody.innerHTML += `<tr><td colspan="8" class="section-header">${title}</td></tr>`;
                        lastSection = item.section;
                    }
                    tbody.innerHTML += `<tr><td><b>${item.room}</b></td><td>${item.living||'-'}</td><td>${item.kitchen||'-'}</td><td>${item.bath||'-'}</td><td>${item.bed1||'-'}</td><td>${item.bed2||'-'}</td><td>${item.start||''}</td><td>${item.end||''}</td></tr>`;
                });
                window.print(); 
            },

            sendWhatsApp() {
                let t = `*ğŸ§¹ Report - ${this.t(this.state.branchKey)}*\nğŸ‘¤ ${this.state.supervisor}\n\n`;
                ['checkout', 'customer'].forEach(s => {
                    const l = this.state.data.filter(i => i.section === s);
                    if(l.length) { t += `*${s==='checkout'?'ğŸ”´ Checkout':'ğŸ”µ Guest'}*\n`; l.forEach(i => t += `ğŸ”¹ *${i.room}* ${i.maintenance ? 'âš ï¸':''} (${i.start||'-'} > ${i.end||'-'})\n   L:${i.living||'-'} K:${i.kitchen||'-'} B:${i.bath||'-'}\n`); t+='\n'; }
                });
                window.open(`https://wa.me/?text=${encodeURIComponent(t)}`, '_blank');
            }
        };

        window.app = app;
        app.init();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller && confirm("ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ Ù…ØªÙˆÙØ±! ØªØ­Ø¯ÙŠØ«ØŸ")) window.location.reload();
                        });
                    });
                });
            });
        }
    </script>
</body>
</html>